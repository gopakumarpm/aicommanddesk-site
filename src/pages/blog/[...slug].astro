---
import BaseLayout from '../../layouts/BaseLayout.astro';
import NewsletterCTA from '../../components/NewsletterCTA.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug && p.data.category === post.data.category)
  .slice(0, 3);

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const readingTime = Math.ceil(post.body.split(/\s+/).length / 200);
const postUrl = `https://aicommanddesk.com/blog/${post.slug}`;

const categoryColors: Record<string, string> = {
  'AI Tools': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'AI Strategy': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
  'AI Automation': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'AI for Teams': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  'Case Studies': 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
  'Tutorials': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
};

const colorClass = categoryColors[post.data.category] || 'bg-gray-100 text-gray-700';
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  type="article"
  date={post.data.date.toISOString()}
>
  <article>
    <!-- Header -->
    <header class="bg-gradient-to-br from-navy-500 to-electric-600 text-white py-16 md:py-20">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-3 mb-4">
          <span class={`text-xs font-medium px-3 py-1 rounded-full ${colorClass}`}>
            {post.data.category}
          </span>
          <time class="text-sm text-gray-300" datetime={post.data.date.toISOString()}>
            {formattedDate}
          </time>
          <span class="text-sm text-gray-400">&bull; {readingTime} min read</span>
        </div>
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold leading-tight">
          {post.data.title}
        </h1>
        <p class="mt-4 text-lg text-gray-300 max-w-2xl">{post.data.description}</p>
        <div class="mt-6 flex items-center gap-3">
          <div class="w-10 h-10 bg-electric-400 rounded-full flex items-center justify-center font-bold text-white">
            {post.data.author.charAt(0)}
          </div>
          <div>
            <p class="font-medium text-white">{post.data.author}</p>
            <p class="text-sm text-gray-400">AICommandDesk</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="flex flex-col lg:flex-row gap-12">
        <!-- Main Content -->
        <div class="flex-1 max-w-4xl">
          <div class="prose prose-lg dark:prose-dark max-w-none">
            <Content />
          </div>

          <!-- Tags -->
          {post.data.tags.length > 0 && (
            <div class="mt-10 pt-6 border-t border-gray-200 dark:border-navy-400">
              <div class="flex items-center flex-wrap gap-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Tags:</span>
                {post.data.tags.map((tag: string) => (
                  <span class="text-xs px-3 py-1 rounded-full bg-gray-100 dark:bg-navy-400 text-gray-600 dark:text-gray-300">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}

          <!-- Share -->
          <div class="mt-8 pt-6 border-t border-gray-200 dark:border-navy-400">
            <ShareButtons title={post.data.title} url={postUrl} />
          </div>

          <!-- Inline Newsletter -->
          <div class="mt-10">
            <NewsletterCTA
              variant="inline"
              title="Enjoyed this article?"
              description="Get more practical AI tips delivered to your inbox every week."
            />
          </div>

          <!-- Author Bio -->
          <div class="mt-10 p-6 bg-gray-50 dark:bg-navy-600 rounded-xl border border-gray-200 dark:border-navy-400">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 bg-electric-500 rounded-full flex items-center justify-center font-bold text-white text-xl flex-shrink-0">
                A
              </div>
              <div>
                <h3 class="font-bold text-navy-500 dark:text-white">AICommandDesk</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 leading-relaxed">
                  We help managers and professionals leverage AI to work smarter, automate tasks, and lead more effectively â€” all without writing a single line of code.
                </p>
                <a href="/about" class="text-sm text-electric-500 hover:text-electric-600 font-medium mt-2 inline-block">
                  Learn more &rarr;
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar (Table of Contents) -->
        <aside class="hidden lg:block w-72 flex-shrink-0">
          <div class="sticky top-28">
            {headings.length > 0 && (
              <div class="p-5 bg-gray-50 dark:bg-navy-600 rounded-xl border border-gray-200 dark:border-navy-400">
                <h4 class="font-bold text-sm text-navy-500 dark:text-white uppercase tracking-wider mb-4">
                  Table of Contents
                </h4>
                <nav class="space-y-2">
                  {headings.filter(h => h.depth <= 3).map((heading) => (
                    <a
                      href={`#${heading.slug}`}
                      class={`block text-sm transition-colors hover:text-electric-500 dark:hover:text-electric-400 ${
                        heading.depth === 2
                          ? 'text-gray-700 dark:text-gray-300'
                          : 'text-gray-500 dark:text-gray-400 pl-3'
                      }`}
                    >
                      {heading.text}
                    </a>
                  ))}
                </nav>
              </div>
            )}
          </div>
        </aside>
      </div>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="py-12 bg-gray-50 dark:bg-navy-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="section-heading mb-8">Related Articles</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {relatedPosts.map((p) => (
              <BlogCard
                title={p.data.title}
                description={p.data.description}
                date={p.data.date}
                category={p.data.category}
                slug={p.slug}
              />
            ))}
          </div>
        </div>
      </section>
    )}
  </article>
</BaseLayout>
